---
# OpenClaw Migration Role
# Transitions from manual scripts to Ansible automation

- name: Migrate | Stop existing manual cron jobs
  ansible.builtin.shell:
    cmd: crontab -l | grep -v ansible | crontab -
  register: old_cron
  changed_when: false
  ignore_errors: true

- name: Migrate | Display old cron jobs
  debug:
    msg: "Old cron jobs (now removed): {{ old_cron.stdout_lines | default(['No cron jobs found']) }}"
  when: old_cron.stdout_lines is defined and old_cron.stdout_lines | length > 0

- name: Migrate | Remove old backup script
  ansible.builtin.file:
    path: "{{ workspace_dir }}/tools/backup.py"
    state: absent
  when: stat_result.stat.exists

- name: Migrate | Configure OpenClaw config for automation
  ansible.builtin.copy:
    content: "automation:\n  managed_by: ansible\n"
    dest: "{{ workspace_dir }}/openclaw.json"
    mode: '0600'

- name: Migrate | Set up new backup script
  ansible.builtin.copy:
    src: "{{ workspace_dir }}/templates/backup_ansible.j2"
    dest: "{{ workspace_dir }}/tools/backup.py"
    mode: '0755'

- name: Migrate | Configure Ansible cron job for backup
  ansible.builtin.cron:
    name: "{{ lookup('env', 'USER') | default('Papa') }} - OpenClaw Ansible Backup"
    user: "{{ lookup('env', 'USER') | default('Papa') }}"
    job: "cd {{ workspace_dir }} && python3 {{ backup.script_path }}"
    state: present
    backup: yes
