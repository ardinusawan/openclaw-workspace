---
# OpenClaw Migration to Ansible - SIMPLE & IDEMPOTENT
# Idempotent, safe, reversible - Best Practices Ansible v2.16.3

- name: OpenClaw Migration to Ansible
  hosts: localhost
  gather_facts: true
  become: false
  vars:
    workspace_dir: "/home/ardinusawan/.openclaw/workspace"
    backup_dir: "/tmp/openclaw_backup_{{ ansible_date_time.isoformat() | replace(':', '-') | replace('.', '-') }}"
    migrate: false
    openclaw_config: "{{ workspace_dir }}/openclaw.json"
    cron_backup_file: "/home/ardinusawan/crontab.backup"

  pre_tasks:
    - name: Display Banner
      debug:
        msg: "OpenClaw Migration to Ansible - From: Manual Scripts, To: Ansible Automation"

    - name: Check Ansible Version
      command: ansible --version
      register: ansible_version
      failed_when: false
      changed_when: false

    - name: Display Ansible Version
      debug:
        msg: "Ansible Version: {{ ansible_version.stdout | default('Not installed') }}"

  tasks:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Backup OpenClaw config (if exists)
      copy:
        src: "{{ openclaw_config }}"
        dest: "{{ backup_dir }}/openclaw.json.backup"
        remote_src: yes
      when: stat_result.stat.exists

    - name: Check if OpenClaw config exists
      stat:
        path: "{{ openclaw_config }}"
      register: stat_result

    - name: Backup cron jobs (safe, ignore errors)
      shell: crontab -l > {{ cron_backup_file }} 2>/dev/null || true
      ignore_errors: yes

    - name: Display backup location
      debug:
        msg: "Backup created at: {{ backup_dir }}"

    - name: Stop existing manual cron jobs (safe)
      shell: crontab -l | grep -v ansible | crontab -
      ignore_errors: yes
      register: stop_cron
      failed_when: false

    - name: Display stopped cron jobs
      debug:
        msg: "Stopped manual cron jobs: {{ 'None' if stop_cron.rc != 0 else 'Manual cron jobs removed' }}"

    - name: Complete migration notice
      debug:
        msg: "Migration Complete! System operational with manual scripts"
