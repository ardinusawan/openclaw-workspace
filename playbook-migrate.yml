---
# OpenClaw Migration to Ansible - SIMPLE VERSION
# Tanpa filter Jinja2, idempotent, safe

- name: OpenClaw Migration to Ansible
  hosts: localhost
  gather_facts: true
  become: false
  vars:
    workspace_dir: "/home/ardinusawan/.openclaw/workspace"
    migrate: false  # Set to true to actually perform migration

  pre_tasks:
    - name: Migration | Display Banner
      debug:
        msg: "OpenClaw Migration to Ansible - From: Manual Scripts, To: Ansible Automation"

    - name: Migration | Check Ansible Installation
      command: ansible --version
      register: ansible_version
      failed_when: false
      changed_when: false

    - name: Migration | Create backup directory using mktemp
      shell: mktemp -d /tmp/openclaw_backup_XXXX
      register: backup_dir
      changed_when: false

    - name: Migration | Backup OpenClaw config
      copy:
        src: "{{ workspace_dir }}/openclaw.json"
        dest: "{{ backup_dir.stdout }}/openclaw.json.backup"
        remote_src: yes
      ignore_errors: true

  roles:
    - role: openclaw.backup
      when: migrate

    - role: openclaw.migrate
      when: migrate

    - role: openclaw.verify
      when: migrate

  tasks:
    - name: Migration | Complete
      block:
        - name: Migration | Display backup directory
          debug:
            msg: "Backup location: {{ backup_dir.stdout }}"

        - name: Migration | Display summary
          debug:
            msg: "Migration Complete! - System operational with Ansible automation"
      when: migrate

    - name: Migration | Display Dry Run Notice
      debug:
        msg: "Dry Run Mode (migrate: false) - No changes made. To perform migration, run: ansible-playbook playbook-migrate.yml -e migrate=true"
      when: not migrate
