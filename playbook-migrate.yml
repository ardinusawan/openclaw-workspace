---
# OpenClaw Migration Playbook
# Idempotent, safe, reversible migration from manual scripts

- name: OpenClaw Migration to Ansible
  hosts: localhost
  gather_facts: true
  become: false
  vars_files:
    - vars/secret.yml  # API keys, tokens (gitignored)
    - vars/main.yml   # Main configuration
    - vars/config.yml  # User-specific settings
  vars:
    workspace_dir: "{{ lookup('env', 'HOME') }}/.openclaw/workspace"
    backup_dir: "/tmp/openclaw_migration_{{ ansible_date_time.epoch() }}"
    migrate: false  # Set to true to actually perform migration

  pre_tasks:
    - name: Migration | Display Banner
      debug:
        msg: "OpenClaw Migration to Ansible - From: Manual Scripts, To: Ansible Automation"

    - name: Migration | Check Ansible Installation
      command: ansible --version
      register: ansible_version
      failed_when: false

    - name: Migration | Display Ansible Version
      debug:
        msg: "Ansible Version: {{ ansible_version.stdout | default('Not installed') }}"

    - name: Migration | Check Current System State
      debug:
        msg: "Checking current system state..."

    - name: Migration | Create Backup Directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'

    - name: Migration | Backup OpenClaw Config
      copy:
        src: "{{ workspace_dir }}/openclaw.json"
        dest: "{{ backup_dir }}/openclaw.json.backup"
        remote_src: yes
      when: stat_result.stat.exists
      register: openclaw_backup

    - name: Migration | Backup Cron Configuration
      shell: crontab -l | grep "backup.py" > {{ backup_dir }}/crontab.backup 2>/dev/null || true
      register: cron_backup
      ignore_errors: true

    - name: Migration | Display Backup Status
      debug:
        msg:
          - "Backup created: {{ backup_dir }}"
          - "OpenClaw config: {{ 'BACKED UP' if openclaw_backup.changed else 'ALREADY BACKED' }}"
          - "Cron job: {{ 'BACKED UP' if cron_backup is skipped else 'SKIPPED (no cron job)' }}"

  roles:
    - role: openclaw.current_state
      when: migrate

    - role: openclaw.backup
      when: migrate

    - role: openclaw.migrate
      when: migrate

    - role: openclaw.verify
      when: migrate

  tasks:
    - name: Migration | Complete
      block:
        - name: Migration | Verify Cron Job
          shell: crontab -l | grep "ansible"
          register: new_cron
          changed_when: false
          ignore_errors: true

        - name: Migration | Display Summary
          debug:
            msg:
              - "Migration Status: COMPLETE"
              - "Current Cron Jobs (Ansible): {{ new_cron.stdout_lines | default(['No cron jobs found']) }}"
      when: migrate

    - name: Migration | Display Dry Run Notice
      debug:
        msg: "Dry Run Mode (migrate: false) - No changes made. To perform migration, run: ansible-playbook playbook.yml -e migrate=true"
      when: not migrate
