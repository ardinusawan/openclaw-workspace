---
# Ansible-managed Backup Script
# Runs automated backups of private and public repositories

import subprocess
import json
import os
import requests
from datetime import datetime

# Configuration
WORKSPACE_DIR = "/home/ardinusawan/.openclaw/workspace"
PRIVATE_DIR = f"{WORKSPACE_DIR}/private-data"
CONFIG_PATH = f"{WORKSPACE_DIR}/openclaw.json"
LOG_FILE = "/home/ardinusawan/cron_backup.log"

def run_command(cmd, cwd=None):
    """Jalankan shell command dan return output"""
    try:
        result = subprocess.run(
            cmd,
            shell=True,
            cwd=cwd,
            capture_output=True,
            text=True,
            timeout=300
        )
        return result.returncode == 0, result.stdout.strip(), result.stderr.strip()
    except subprocess.TimeoutExpired:
        return False, "Command timeout", ""
    except Exception as e:
        return False, f"Error: {str(e)}", ""

def backup_private_repo():
    """Backup private repository (MEMORY.md, config.json, media/)"""
    
    print(f"ğŸ“ Backing up private repository...")
    print(f"   Directory: {PRIVATE_DIR}")
    
    # Add semua file
    success, stdout, stderr = run_command(f"cd {PRIVATE_DIR} && git add .", cwd=WORKSPACE_DIR)
    
    if not success:
        print(f"   âŒ Error adding files: {stderr}")
        return False
    
    # Commit
    date_str = datetime.now().strftime("%Y-%m-%d")
    success, stdout, stderr = run_command(f'cd {PRIVATE_DIR} && git commit -m "Ansible Auto Backup {date_str}"', cwd=WORKSPACE_DIR)
    
    if not success:
        print(f"   âŒ Error committing: {stderr}")
        return False
    
    print(f"   âœ… Commit: {stdout.split(chr(10))[0] if chr(10) in stdout else stdout}")
    
    # Push
    success, stdout, stderr = run_command(f"cd {PRIVATE_DIR} && git push", cwd=WORKSPACE_DIR)
    
    if not success:
        print(f"   âŒ Error pushing: {stderr}")
        return False
    
    print(f"   âœ… Push: {stdout.split(chr(10))[0] if chr(10) in stdout else stdout}")
    
    return True

def backup_public_repo():
    """Backup public repository (scripts, tools, documentation)"""
    
    print(f"ğŸ“ Backing up public repository...")
    
    # Add semua file
    success, stdout, stderr = run_command(f"cd {WORKSPACE_DIR} && git add .", cwd=WORKSPACE_DIR)
    
    if not success:
        print(f"   âŒ Error adding files: {stderr}")
        return False
    
    # Commit
    date_str = datetime.now().strftime("%Y-%m-%d")
    success, stdout, stderr = run_command(f'cd {WORKSPACE_DIR} && git commit -m "Ansible Auto Backup {date_str}"', cwd=WORKSPACE_DIR)
    
    if not success:
        print(f"   âŒ Error committing: {stderr}")
        return False
    
    print(f"   âœ… Commit: {stdout.split(chr(10))[0] if chr(10) in stdout else stdout}")
    
    # Push
    success, stdout, stderr = run_command(f"cd {WORKSPACE_DIR} && git push", cwd=WORKSPACE_DIR)
    
    if not success:
        print(f"   âŒ Error pushing: {stderr}")
        return False
    
    print(f"   âœ… Push: {stdout.split(chr(10))[0] if chr(10) in stdout else stdout}")
    
    return True

def send_telegram_notification():
    """Kirim notifikasi ke Telegram via Brave Search API"""
    # Cek apakah ada API key di config
    try:
        with open(CONFIG_PATH, 'r') as f:
            config = json.load(f)
            
        brave_key = config.get('channels', {}).get('telegram', {}).get('braveApiKey', None)
        
        if not brave_key:
            print("   âš ï¸  Brave API key tidak ditemukan, skip notifikasi")
            return
        
        # Baca user ID dari config
        user_id = None
        telegram_config = config.get('channels', {}).get('telegram', {})
        if isinstance(telegram_config, dict):
            user_id = telegram_config.get('allowFrom', [])
            if isinstance(user_id, list) and len(user_id) > 0:
                user_id = str(user_id[0])
        
        if not user_id:
            print("   âš ï¸  User ID tidak ditemukan di config")
            return
        
        # Kirim pesan ke Telegram
        bot_token = telegram_config.get('botToken', None)
        if not bot_token:
            print("   âš ï¸  Bot token tidak ditemukan")
            return
        
        message = f"""
ğŸ“… **Ansible Auto Backup - {datetime.now().strftime('%Y-%m-%d %H:%M')}**

Workspace: {WORKSPACE_DIR}

Backup Status:
âœ… Private Repository: Berhasil dipush
âœ… Public Repository: Berhasil dipush

Brave Search API:
âœ… Terintegrasi untuk notifikasi backup
ğŸ“Š Status: Ansible Managed
ğŸš€ Automation: Idempotent & Reversible

Next backup: ~24 jam lagi
"""
        
        url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        data = {
            "chat_id": user_id,
            "text": message,
            "parse_mode": "Markdown"
        }
        
        response = requests.post(url, json=data, timeout=10)
        
        if response.status_code == 200:
            print("   âœ… Notifikasi terkirim ke Telegram")
        else:
            print(f"   âŒ Error kirim notifikasi: {response.status_code}")
            
    except Exception as e:
        print(f"   âŒ Error kirim notifikasi: {str(e)}")

def main():
    """Fungsi utama"""
    
    print("=" * 60)
    print("ğŸ”„ Ansible Auto Backup - OpenClaw Workspace")
    print("=" * 60)
    print(f"ğŸ“… Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ¤– Automation: Ansible (Idempotent, Reversible)")
    print()
    
    # Backup private repo
    private_success = backup_private_repo()
    
    # Backup public repo
    public_success = backup_public_repo()
    
    # Kirim notifikasi jika sukses
    if private_success and public_success:
        print()
        print("ğŸ’¡ Mengirim notifikasi via Brave Search API...")
        send_telegram_notification()
    
    # Summary
    print()
    print("=" * 60)
    print("ğŸ“Š Backup Summary:")
    print("=" * 60)
    
    if private_success and public_success:
        print("âœ… Private Repository: Berhasil dipush")
        print("âœ… Public Repository: Berhasil dipush")
        print("âœ… Automation: Ansible Managed")
    elif private_success:
        print("âœ… Private Repository: Berhasil dipush")
        print("âš ï¸  Public Repository: Tidak ada perubahan")
    elif public_success:
        print("âš ï¸  Private Repository: Tidak ada perubahan")
        print("âœ… Public Repository: Berhasil dipush")
    else:
        print("âŒ Backup gagal")
    
    print()
    print("ğŸ“… Next backup akan berjalan dalam 24 jam")
    print("=" * 60)

if __name__ == "__main__":
    main()
